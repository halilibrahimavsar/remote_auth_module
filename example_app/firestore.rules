rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ===============================================================
    // Assumed Data Model
    // ===============================================================
    //
    // Collection: users
    // Document ID: [uid]
    // Fields:
    //   - uid: string (required) - immutable
    //   - email: string (optional/required)
    //   - displayName: string (optional)
    //   - photoURL: string (optional)
    //   - createdAt: timestamp (required) - immutable
    //   - updatedAt: timestamp (required)
    //   - lastLoginAt: timestamp (optional)
    //
    // ===============================================================

    // ===============================================================
    // Helper Functions
    // ===============================================================
    //
    // Check if the user is authenticated
    function isAuthenticated() {
       return request.auth != null;
    }
    //
    // Check if user owns the resource (based on document ID)
    function isOwner(userId) {
       return isAuthenticated() && request.auth.uid == userId;
    }
    //
    // Verify UID hasn't been tampered with on create
    function uidUnchanged() {
       return !('uid' in request.resource.data) ||
         request.resource.data.uid == request.auth.uid;
    }
    //
    // Ensure uid field is not modified on update
    function uidNotModified() {
       return !('uid' in request.resource.data) ||
         request.resource.data.uid == resource.data.uid;
    }
    //
    // Ensure createdAt field is not modified on update
    function createdAtNotModified() {
       return !('createdAt' in request.resource.data) ||
         request.resource.data.createdAt == resource.data.createdAt;
    }
    //
    // Validate required fields exist for user creation
    function hasRequiredUserFields() {
       return request.resource.data.keys().hasAll(['uid', 'createdAt', 'updatedAt']);
    }

    // ===============================================================
    // Collections
    // ===============================================================
    match /users/{userId} {
      allow read: if isOwner(userId);
      
      allow create: if isOwner(userId) 
                    && hasRequiredUserFields()
                    && request.resource.data.uid == userId
                    && uidUnchanged()
                    && request.resource.data.createdAt is timestamp
                    && request.resource.data.updatedAt is timestamp;
                    
      allow update: if isOwner(userId)
                    && uidNotModified()
                    && createdAtNotModified()
                    && (!('updatedAt' in request.resource.data) || request.resource.data.updatedAt is timestamp)
                    && (!('lastLoginAt' in request.resource.data) || request.resource.data.lastLoginAt is timestamp);
                    
      allow delete: if isOwner(userId);
    }
  }
}
